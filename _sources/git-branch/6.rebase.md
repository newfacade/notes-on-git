# 变基

```{note}
在 Git 中整合来自不同分支的修改主要有两种方式：`merge` 和 `rebase`。在本节我们将学习什么是“变基”，怎样使用“变基”，将展示该操作的惊艳之处，以及指出在何种情况下你应该避免使用它。
```

## 变基的基本操作

我们看一个例子，开发任务分到了两个不同的分支，又各自提交了更新：

![](../images/rebase1.png)

之前介绍过，整合更新最容易的方法是 `merge` 命令。它会把两个分支的最新快照（C3 和 C4）以及二者的最近共同祖先（C2）进行三方合并，合并的结果是生成一个新的快照（并提交）。

![](../images/rebase2.png)

其实，还有一种方法：你可以提取在 C4 引入的修改，然后在 C3 的基础上应用一次。在 Git 中，这种操作就叫做变基（rebase）。你可以使用 `rebase` 命令将提交到某一分支上的所有修改都移至另一个分支上。

在这个例子中，你可以检出 experiment 分支，然后将它变基到 master 分支上：

```
$ git checkout experiment
$ git rebase master
First, rewinding head to replay your work on top of it...
Applying: added staged command
```

它的原理是首先找到两个分支的最近共同祖先 C2，然后对比当前分支相对于该祖先的历次提交，提取相应的修改并存为临时文件，然后将当前分支指向目标基底 C3，最后以此将之前另存为临时文件的修改依序应用。

![](../images/rebase3.png)

现在回到 master 分支，进行一次合并快进。

```
$ git checkout master
$ git merge experiment
```

![](../images/rebase4.png)

此时，C4' 所指向的快照就和 C5 一模一样了。这两种方法的最终结果没有任何区别，但是变基使得提交历史更加简洁。尽管实际开发过程是并行的，但它们看上去就像是串行一样。

一般我们这样做的目的是确保在向远程分支推送时能保持提交历史的整洁——例如向某个其他人维护的项目贡献代码时。在这种情况下，你首先在自己的分支里进行开发，当开发完成时你需要先将你的代码变基到 origin/master 上，然后再向主项目提交修改。这样的话，该项目的维护者就不再需要进行整合工作，只需要快进合并即可。


## 变基的风险

奇妙的变基也并非完美无缺，要用它得遵守一条准则：

```{tip}
如果提交存在于你的仓库之外，而别人可能基于这些提交进行开发，那么不要执行变基。
```

变基操作的实质是丢弃一些现有的提交，然后相应地新建一些内容一样但实际上不同的提交。如果你已经将提交推送至某个仓库，而其他人也已经从该仓库拉取提交并进行了后续工作，此时，如果你用 `git rebase` 命令重新整理了提交并再次推送，你的同伴将不得不再次将他们手头的工作与你的提交进行整合，事情就会变得一团糟。


